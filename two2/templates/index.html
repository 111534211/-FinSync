{% extends "base.html" %}
{% block content %}
<style>
    body {
        background-color: #f8faff;
        color: #333;
    }

    .card {
        border-radius: 15px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
    }

    .btn-primary-custom {
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 8px;
        transition: 0.2s;
    }

    .btn-primary-custom:hover {
        background-color: #0b5ed7;
        transform: translateY(-1px);
    }

    .member-badge {
        background: #fff;
        border: 1px solid #eef2f7;
        color: #555;
        border-radius: 8px;
        padding: 6px 10px;
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
    }

    .exchange-card {
        border: 1.5px solid #0d6efd !important;
        background-color: #ffffff;
        border-radius: 15px;
        padding: 1.25rem;
    }

    .exchange-label {
        font-size: 0.75rem;
        font-weight: bold;
        color: #0d6efd;
        margin-bottom: 4px;
    }

    .folder-scroll-container {
        display: flex;
        overflow-x: auto;
        gap: 12px;
        padding-bottom: 10px;
    }

    .folder-scroll-container::-webkit-scrollbar {
        display: none;
    }

    .folder-card {
        min-width: 160px;
        background: #fff;
        border: 1px solid #eef2f7 !important;
        cursor: pointer;
        transition: 0.3s;
        border-radius: 15px;
        flex-shrink: 0;
    }

    .folder-card.active-folder {
        border: 2.5px solid #0d6efd !important;
        background: #f0f7ff !important;
    }

    .x-small {
        font-size: 0.7rem;
    }

    .invalid-feedback {
        display: none;
        color: #dc3545;
        font-size: 0.75rem;
        margin-top: 4px;
    }
</style>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-4">
            <div class="card p-3 mb-3 border-0 shadow-sm" style="background-color: #f8f9fa;">
                <h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-database-fill-gear"></i> è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h6>
                <div class="d-grid gap-2">
                    <a href="/export_csv" class="btn btn-sm btn-outline-success">
                        <i class="bi bi-file-earmark-arrow-down"></i> åŒ¯å‡ºæ‰€æœ‰æ”¯å‡ºç´€éŒ„ (CSV)
                    </a>

                    <button class="btn btn-sm btn-outline-primary"
                        onclick="document.getElementById('importFile').click()">
                        <i class="bi bi-file-earmark-arrow-up"></i> åŒ¯å…¥æ”¯å‡ºç´€éŒ„ (CSV)
                    </button>

                    <form id="importForm" action="/import_csv" method="POST" enctype="multipart/form-data"
                        style="display: none;">
                        <input type="file" name="file" id="importFile" accept=".csv" onchange="submitImport()">
                    </form>
                </div>
                <div class="x-small text-muted mt-2">
                    <i class="bi bi-info-circle"></i> åŒ¯å…¥æ™‚è«‹ç¢ºä¿ CSV æ¬„ä½åç¨±æ­£ç¢ºã€‚
                </div>
            </div>
            <div class="card p-3 mb-3">
                <h6 class="fw-bold mb-3 text-secondary"><i class="bi bi-people-fill"></i> æ—…ä¼´åå–®</h6>
                <form action="/add_member" method="POST" class="mb-3">
                    <div class="input-group input-group-sm">
                        <input type="text" name="member_name" class="form-control" placeholder="è¼¸å…¥å§“å" required>
                        <button type="submit" class="btn btn-primary-custom">æ–°å¢</button>
                    </div>
                </form>
                <div class="d-flex flex-wrap gap-2">
                    {% for m in members %}
                    <div class="member-badge shadow-sm">
                        {{ m }}
                        <a href="/delete_member/{{ m }}" class="text-danger ms-2" onclick="return confirm('ç¢ºå®šç§»é™¤ï¼Ÿ')">
                            <i class="bi bi-x-circle-fill"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card p-4 shadow-sm mb-3">
                <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-plus-circle-fill"></i> è¨˜éŒ„æ”¯å‡º</h6>

                <form action="/add" method="POST" id="main_expense_form" onsubmit="return validateForm()">
                    <input type="hidden" name="currency" id="hidden_currency" value="TWD">
                    <input type="hidden" name="foreign_amount" id="hidden_foreign_amount" value="0">
                    <input type="hidden" name="note" id="hidden_note" value="">

                    <div class="mb-3">
                        <label class="x-small fw-bold text-muted">æ­¸é¡è¡Œç¨‹ <span class="text-danger">*</span></label>
                        <select name="folder_id" id="folder_select" class="form-select border-light-blue"
                            onchange="toggleNewFolderInput()" required>
                            <option value="" disabled selected>-- è«‹é¸æ“‡è¡Œç¨‹ --</option>
                            <option value="NEW" class="fw-bold text-primary">+ æ–°å¢è¡Œç¨‹è³‡æ–™å¤¾...</option>
                            {% for f in folders %}<option value="{{ f.id }}">{{ f.folder_name }}</option>{% endfor %}
                        </select>
                    </div>

                    <div id="new_folder_div" class="mb-3" style="display:none;">
                        <input type="text" name="new_folder_name" id="new_folder_name"
                            class="form-control form-control-sm border-primary" placeholder="è¼¸å…¥æ–°è¡Œç¨‹åç¨±">
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="x-small fw-bold text-muted">æ—¥æœŸ</label>
                            <input type="date" name="date" class="form-control" value="{{ today_str }}" required>
                        </div>
                        <div class="col-6">
                            <label class="x-small fw-bold text-muted">é …ç›® <span class="text-danger">*</span></label>
                            <input type="text" name="description" class="form-control" placeholder="å¦‚ï¼šåˆé¤" required>
                        </div>
                    </div>

                    <div class="mb-3 text-center">
                        <label class="x-small fw-bold text-muted">å°å¹£é‡‘é¡ (TWD) <span class="text-danger">*</span></label>
                        <input type="number" name="amount" id="form_amount_twd"
                            class="form-control form-control-lg fw-bold border-0 text-center text-primary"
                            style="font-size: 2.2rem;" placeholder="0" required min="1">
                    </div>

                    <div class="mb-3">
                        <label class="x-small fw-bold text-muted">èª°å¢ŠéŒ¢ï¼Ÿ</label>
                        <select name="payer" class="form-select" required>
                            {% for m in members %}<option value="{{ m }}">{{ m }}</option>{% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <label class="x-small fw-bold text-muted">åˆ†æ”¤æˆå“¡ (å¿…é¸)</label>
                            <button type="button" class="btn btn-link p-0 x-small text-decoration-none"
                                id="btn_toggle_all" onclick="toggleAllSplitters()">å…¨é¸ / å–æ¶ˆ</button>
                        </div>
                        <div class="p-2 border rounded bg-light overflow-auto" style="max-height: 100px;"
                            id="splitter_group">
                            {% for m in members %}
                            <div class="form-check">
                                <input class="form-check-input splitter-check" type="checkbox" name="splitters"
                                    value="{{ m }}" id="s_{{ m }}" checked>
                                <label class="form-check-label x-small" for="s_{{ m }}">{{ m }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        <div id="splitter_error" class="invalid-feedback">è«‹è‡³å°‘é¸æ“‡ä¸€ä½æˆå“¡é€²è¡Œåˆ†æ”¤</div>
                    </div>

                    <button type="submit" class="btn btn-primary-custom w-100 py-2 fw-bold">å­˜å…¥è³‡æ–™å¤¾</button>
                </form>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="exchange-card mb-4 shadow-sm">
                <h6 class="fw-bold mb-3 text-primary"><i class="bi bi-currency-exchange"></i> å¤–å¹£é›™å‘æ›ç®—</h6>
                <div class="row g-2 align-items-end">
                    <div class="col-md-3 col-6">
                        <div class="exchange-label">å¹£åˆ¥</div>
                        <select id="calc_currency" class="form-select form-select-sm" onchange="runConvert('toTWD')">
                            <option value="JPY">ğŸ‡¯ğŸ‡µ æ—¥å¹£ (JPY)</option>
                            <option value="KRW">ğŸ‡°ğŸ‡· éŸ“å…ƒ (KRW)</option>
                            <option value="USD">ğŸ‡ºğŸ‡¸ ç¾é‡‘ (USD)</option>
                            <option value="THB">ğŸ‡¹ğŸ‡­ æ³°éŠ– (THB)</option>
                            <option value="EUR">ğŸ‡ªğŸ‡º æ­å…ƒ (EUR)</option>
                            <option value="GBP">ğŸ‡¬ğŸ‡§ è‹±éŠ (GBP)</option>
                            <option value="HKD">ğŸ‡­ğŸ‡° æ¸¯å¹£ (HKD)</option>
                            <option value="CNY">ğŸ‡¨ğŸ‡³ äººæ°‘å¹£ (CNY)</option>
                            <option value="VND">ğŸ‡»ğŸ‡³ è¶Šå—ç›¾ (VND)</option>
                            <option value="AUD">ğŸ‡¦ğŸ‡º æ¾³å¹£ (AUD)</option>
                        </select>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="exchange-label">å¤–å¹£é‡‘é¡</div>
                        <input type="number" id="calc_foreign" class="form-control form-control-sm" placeholder="0"
                            oninput="runConvert('toTWD')">
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="exchange-label">å°å¹£ (TWD)</div>
                        <input type="number" id="calc_twd" class="form-control form-control-sm fw-bold bg-light"
                            placeholder="0" oninput="runConvert('fromTWD')">
                    </div>
                    <div class="col-md-3 col-6">
                        <button class="btn btn-primary-custom btn-sm w-100 py-2 fw-bold"
                            onclick="applyToMainForm()">å¸¶å…¥é‡‘é¡</button>
                    </div>
                </div>
            </div>

            <div class="folder-scroll-container mb-4">
                {% for f in folders %}
                <div class="card folder-card shadow-sm" id="folder_card_{{ f.id }}"
                    onclick="filterExpenses({{ f.id }}, '{{ f.folder_name }}')">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-folder-fill text-primary me-2"></i>
                                <span class="small fw-bold folder-name">{{ f.folder_name }}</span>
                            </div>
                            <a href="/delete_folder/{{ f.id }}" class="text-danger x-small"
                                onclick="event.stopPropagation(); return confirm('ç¢ºå®šåˆªé™¤è¡Œç¨‹èˆ‡æ‰€æœ‰ç´€éŒ„ï¼Ÿ')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </div>
                        <div class="h5 fw-bold mb-0 text-dark">NT$ {{ "{:,.0f}".format(f.total_amount) }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div id="settlement_card" class="card mb-3 border-0 shadow-sm"
                style="display:none; background-color: #f0f7ff; border-left: 5px solid #0d6efd !important;">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="fw-bold text-primary mb-0"><i class="bi bi-wallet2 me-2"></i>èª°è©²çµ¦èª°å¤šå°‘ï¼Ÿ</h6>
                        <span class="badge bg-primary rounded-pill">çµç®—å»ºè­°</span>
                    </div>
                    <div id="settlement_list" class="d-flex flex-wrap gap-2">
                    </div>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white py-3 border-0">
                    <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-receipt-cutoff"></i> <span
                            id="current_folder_name">è«‹é¸å–è¡Œç¨‹</span> æ˜ç´°</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3 border-0">æ—¥æœŸ/é …ç›®</th>
                                <th class="border-0">é‡‘é¡</th>
                                <th class="border-0">åˆ†æ”¤è©³æƒ…</th>
                                <th class="text-end pe-3 border-0">ç®¡ç†</th>
                            </tr>
                        </thead>
                        <tbody id="expense_table_body">
                            <tr>
                                <td colspan="4" class="text-center py-5 text-muted">å°šæœªé¸å–è¡Œç¨‹è³‡æ–™å¤¾</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // 1. é˜²å‘†æ ¡é©—
    function validateForm() {
        const folder = document.getElementById('folder_select').value;
        const splitters = document.querySelectorAll('.splitter-check:checked');
        const errorDiv = document.getElementById('splitter_error');

        if (folder === 'NEW' && !document.getElementById('new_folder_name').value.trim()) {
            alert("è«‹è¼¸å…¥æ–°è¡Œç¨‹åç¨±ï¼");
            return false;
        }

        if (splitters.length === 0) {
            errorDiv.style.display = 'block';
            alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†æ”¤æˆå“¡ï¼");
            return false;
        }
        return true;
    }

    // 2. å…¨é¸/å–æ¶ˆ
    let allSelected = true;
    function toggleAllSplitters() {
        allSelected = !allSelected;
        document.querySelectorAll('.splitter-check').forEach(cb => cb.checked = allSelected);
    }

    // 3. åŒ¯ç‡è©¦ç®—
    const rates = {
        "JPY": 0.22, "KRW": 0.024, "USD": 32.5, "THB": 0.92, "EUR": 35.2,
        "GBP": 41.5, "HKD": 4.15, "CNY": 4.5, "VND": 0.0013, "AUD": 21.5
    };

    function runConvert(dir) {
        const currency = document.getElementById('calc_currency').value;
        const rate = rates[currency];
        const fInput = document.getElementById('calc_foreign'); // å¤–å¹£è¼¸å…¥æ¡†
        const tInput = document.getElementById('calc_twd');     // å°å¹£è¼¸å…¥æ¡†

        if (dir === 'toTWD') {
            // å¤–å¹£è½‰å°å¹£ï¼šå¤–å¹£ * åŒ¯ç‡ = å°å¹£
            if (fInput.value) tInput.value = Math.round(fInput.value * rate);
        } else {
            // å°å¹£è½‰å¤–å¹£ï¼šå°å¹£ / åŒ¯ç‡ = å¤–å¹£
            if (tInput.value) fInput.value = (tInput.value / rate).toFixed(2);
        }
    }

    function applyToMainForm() {
        const twdVal = document.getElementById('calc_twd').value;
        const forVal = document.getElementById('calc_foreign').value;
        const curVal = document.getElementById('calc_currency').value;

        if (twdVal > 0) {
            // å¸¶å…¥ä¸»è¡¨å–®çš„å°å¹£æ¬„ä½
            document.getElementById('form_amount_twd').value = twdVal;
            // é‡è¦ï¼šåŒæ­¥å¸¶å…¥éš±è—çš„å¤–å¹£è³‡è¨Š
            document.getElementById('hidden_currency').value = curVal;
            document.getElementById('hidden_foreign_amount').value = forVal;
            alert(`å·²å¸¶å…¥æ›ç®—çµæœï¼š${curVal} ${forVal} = NT$ ${twdVal}`);
        }
    }

    // 4. æ˜ç´°èˆ‡çµç®—é¡¯ç¤ºé‚è¼¯
    async function filterExpenses(folderId, folderName) {
        // UI ç‹€æ…‹åˆ‡æ›
        document.querySelectorAll('.folder-card').forEach(c => c.classList.remove('active-folder'));
        const activeCard = document.getElementById(`folder_card_${folderId}`);
        if (activeCard) activeCard.classList.add('active-folder');
        document.getElementById('current_folder_name').innerText = folderName;

        const tbody = document.getElementById('expense_table_body');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div> è®€å–ä¸­...</td></tr>';

        // åŒæ­¥åˆ·æ–°é ‚éƒ¨çµç®—å»ºè­°
        fetchSettlement(folderId);

        try {
            const response = await fetch(`/get_expenses/${folderId}`);
            const expenses = await response.json();

            if (expenses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">æ­¤è¡Œç¨‹å°šç„¡æ¶ˆè²»ç´€éŒ„</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            expenses.forEach(e => {
                // è™•ç†åˆ†æ”¤è€…åå–®ï¼šç¢ºä¿è½‰ç‚ºé™£åˆ—ä¸¦å»é™¤ç©ºæ ¼
                const splittersArray = e.splitters ? e.splitters.split(',').map(s => s.trim()) : [];
                const count = splittersArray.length;

                // è¨ˆç®—æ­¤ç­†å¸³å–®æ¯äººå¹³å‡ (å°å¹£)
                const perAmount = count > 0 ? Math.round(e.amount / count) : 0;

                // è™•ç†å¤–å¹£é¡¯ç¤ºé‚è¼¯
                const foreignValue = parseFloat(e.foreign_amount);
                const foreignDisplay = (foreignValue > 0)
                    ? `<div class="x-small text-info fw-bold"><i class="bi bi-globe"></i> ${e.currency} ${foreignValue.toLocaleString()}</div>`
                    : '';

                const row = `
            <tr>
                <td class="ps-3">
                    <div class="small text-muted">${e.date || 'ç„¡æ—¥æœŸ'}</div>
                    <div class="fw-bold text-dark">${e.description}</div>
                    ${foreignDisplay}
                </td>
                <td class="fw-bold text-primary">
                    <span class="x-small">NT$</span> ${Math.round(e.amount).toLocaleString()}
                </td>
                <td class="small">
                    <div class="mb-1">
                        <span class="badge bg-success-subtle text-success" style="font-size: 0.65rem;">æ”¶</span> 
                        <b class="text-success">${e.payer_name}</b>
                    </div>
                    <div class="text-muted" style="font-size: 0.8rem; line-height: 1.4;">
                        <span class="badge bg-danger-subtle text-danger" style="font-size: 0.65rem;">ä»˜</span> 
                        ${splittersArray.map(name => `
                            <span class="d-inline-block border-bottom border-light me-1">
                                ${name}(<span class="text-danger">$${perAmount.toLocaleString()}</span>)
                            </span>
                        `).join('')}
                    </div>
                </td>
                <td class="text-end pe-3">
    <div class="btn-group">
        <a href="/edit_page_view/${e.id}" class="btn btn-sm btn-outline-secondary border-0">
            <i class="bi bi-pencil-square"></i>
        </a>
        
        <a href="/delete/${e.id}" class="btn btn-sm btn-outline-danger border-0" 
           onclick="event.stopPropagation(); return confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ã€Œ${e.description}ã€å—ï¼Ÿ')">
            <i class="bi bi-trash3"></i>
        </a>
    </div>
</td>
            </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        } catch (err) {
            console.error("æ˜ç´°è®€å–å¤±æ•—:", err);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-danger"><i class="bi bi-exclamation-triangle"></i> è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</td></tr>';
        }
    }
    async function fetchSettlement(folderId) {
        const settCard = document.getElementById('settlement_card');
        const settList = document.getElementById('settlement_list');
        try {
            const res = await fetch(`/get_settlement/${folderId}`);
            const transactions = await res.json();

            if (transactions.length > 0) {
                settCard.style.display = 'block';
                settList.innerHTML = transactions.map(t => `
                    <div class="bg-white border rounded-3 px-3 py-2 shadow-sm d-flex align-items-center">
                        <b class="text-danger">${t.from}</b>
                        <i class="bi bi-arrow-right-short mx-2 text-muted"></i>
                        <b class="text-success">${t.to}</b>
                        <span class="ms-2 fw-bold text-primary">$${t.amount.toLocaleString()}</span>
                    </div>
                `).join('');
            } else {
                settCard.style.display = 'none';
            }
        } catch (err) {
            console.error("çµç®—è¨ˆç®—å¤±æ•—", err);
            settCard.style.display = 'none';
        }
    }

    function toggleNewFolderInput() {
        const isNew = document.getElementById('folder_select').value === 'NEW';
        document.getElementById('new_folder_div').style.display = isNew ? 'block' : 'none';
        if (isNew) document.getElementById('new_folder_name').required = true;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const firstFolder = document.querySelector('.folder-card');
        if (firstFolder) firstFolder.click();
    });
    function submitImport() {
        const fileInput = document.getElementById('importFile');
        if (fileInput.files.length > 0) {
            if (confirm("åŒ¯å…¥ CSV å°‡æœƒå¢åŠ ç¾æœ‰ç´€éŒ„ï¼Œç¢ºå®šåŸ·è¡Œï¼Ÿ")) {
                document.getElementById('importForm').submit();
            } else {
                fileInput.value = ""; // æ¸…é™¤é¸å–
            }
        }
    }
</script>
{% endblock %}