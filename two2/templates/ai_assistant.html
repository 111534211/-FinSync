{% extends "base.html" %}

{% block content %}
<style>
    /* å¡ç‰‡ç¾åŒ–ï¼šå´é‚Šè—æ¢èˆ‡æ‡¸åœæ•ˆæœ */
    .itinerary-card {
        border-left: 5px solid #0d6efd !important;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #f8f9fa;
    }

    .itinerary-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
        background: #ffffff;
    }

    /* é™åˆ¶å°å¡ç‰‡åªé¡¯ç¤ºç¬¬ä¸€è¡Œæ¨™é¡Œ */
    .text-truncate-multiline {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<div class="container mt-4">
    <h2 class="mb-4">ğŸ¤– AI æ—…éŠåŠ©æ‰‹</h2>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">è¦åŠƒæ–°è¡Œç¨‹</h5>
                    <div class="mb-3">
                        <label class="form-label">ç›®çš„åœ°</label>
                        <input type="text" id="dest" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ±äº¬ã€å·´é»...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¤©æ•¸</label>
                        <input type="number" id="days" class="form-control" value="3" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—…è¡Œé¢¨æ ¼</label>
                        <select id="style" class="form-select">
                            <option value="æ”¾é¬†ä¼‘é–’">æ”¾é¬†ä¼‘é–’</option>
                            <option value="åƒè²¨è¡Œç¨‹">åƒè²¨è¡Œç¨‹</option>
                            <option value="æ–‡åŒ–å¤è¹Ÿ">æ–‡åŒ–å¤è¹Ÿ</option>
                            <option value="ç˜‹ç‹‚è³¼ç‰©">ç˜‹ç‹‚è³¼ç‰©</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="start_date" class="form-control">
                    </div>
                    <button class="btn btn-primary w-100" onclick="planTrip()" id="planBtn">
                        <span id="btnText">é–‹å§‹ç”Ÿæˆè¡Œç¨‹</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div id="loading" class="text-center d-none">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">AI æ­£åœ¨åŠªåŠ›æ€è€ƒä¸­ï¼Œè«‹ç¨å€™...</p>
            </div>

            <div id="result-container" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4>AI å»ºè­°è¡Œç¨‹ <small class="text-muted" style="font-size: 0.6em;">(é»æ“Šå¡ç‰‡çœ‹è©³æƒ…)</small></h4>
                    <button class="btn btn-success" onclick="importAll()">å…¨éƒ¨åŒ¯å…¥è¬å¹´æ›†</button>
                </div>
                <div id="itinerary-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="itineraryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
            <div class="modal-header bg-primary text-white border-0">
                <h5 class="modal-title" id="modalTitle">ç¬¬ X å¤©è¡Œç¨‹</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody"
                style="white-space: pre-wrap; line-height: 1.8; font-size: 1.1em; padding: 25px; background: #fff;">
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ç¢ºä¿è®Šæ•¸å®šç¾©åœ¨æœ€å¤–å±¤
    let currentItinerary = [];
    let myModal;

    // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.getElementById('itineraryModal');
        if (modalElement) {
            myModal = new bootstrap.Modal(modalElement);
        }
    });

    // ğŸŸ¢ ä¿®æ­£é» 1: ç¢ºä¿å‡½æ•¸å‰é¢æœ‰ async
    async function planTrip() {
        const dest = document.getElementById('dest').value.trim();
        const days = document.getElementById('days').value;
        const style = document.getElementById('style').value;
        const start_date = document.getElementById('start_date').value;

        // åŸºæœ¬é˜²å‘†
        if (!dest || !start_date) {
            alert("è«‹è¼¸å…¥ç›®çš„åœ°èˆ‡æ—¥æœŸï¼");
            return;
        }

        // UI ç‹€æ…‹åˆ‡æ›
        const btn = document.getElementById('planBtn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');

        loading.classList.remove('d-none');
        resultContainer.classList.add('d-none');
        btn.disabled = true;

        try {
            // ğŸŸ¢ ä¿®æ­£é» 2: ä½¿ç”¨ await ç²å–å¾Œç«¯è³‡æ–™
            const response = await fetch('/api/ai_plan_trip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dest, days, style, start_date })
            });

            const data = await response.json();

            // ğŸŸ¢ ä¿®æ­£é» 3: åˆ¤æ–·å›å‚³æ˜¯å¦ç‚ºéŒ¯èª¤è¨Šæ¯
            if (!response.ok || !Array.isArray(data)) {
                // å¦‚æœå¾Œç«¯ä½å€é©—è­‰å¤±æ•—æˆ– AI å£æ‰ï¼Œæœƒå›å‚³ 400/500
                const errorMsg = data.message || "åœ°å€ä¸æ­£ç¢ºæˆ– AI å¿™ç¢Œä¸­";
                alert("âš ï¸ " + errorMsg);
                return;
            }

            // æˆåŠŸç²å–é™£åˆ—ï¼Œæ¸²æŸ“çµæœ
            currentItinerary = data;
            displayItinerary(data);

        } catch (err) {
            console.error("JS Error:", err);
            alert("ç³»çµ±é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
        } finally {
            loading.classList.add('d-none');
            btn.disabled = false;
        }
    }

    function displayItinerary(list) {
        const container = document.getElementById('itinerary-list');
        container.innerHTML = '';

        list.forEach((item, index) => {
            const subTitleMatch = item.content.match(/ã€(.*?)ã€‘/);
            const subTitle = subTitleMatch ? subTitleMatch[1] : "è©³ç´°è¡Œç¨‹";

            const card = `
            <div class="card mb-3 shadow-sm itinerary-card" onclick="showModal(${index})">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <div class="text-primary fw-bold" style="font-size: 0.9em;">${item.date}</div>
                        <div class="fw-bold text-dark">ç¬¬ ${index + 1} å¤©ï¼š${subTitle}</div>
                        <div class="text-muted text-truncate-multiline" style="font-size: 0.85em;">
                            ${item.content.replace(/\\n/g, ' ')}
                        </div>
                    </div>
                    <div class="ms-3 text-primary"><i class="bi bi-chevron-right"></i></div>
                </div>
            </div>`;
            container.innerHTML += card;
        });
        document.getElementById('result-container').classList.remove('d-none');
    }

    function showModal(index) {
        const item = currentItinerary[index];
        if (item && myModal) {
            document.getElementById('modalTitle').innerText = `ç¬¬ ${index + 1} å¤© (${item.date})`;
            document.getElementById('modalBody').innerText = item.content.replace(/\\n/g, '\n');
            myModal.show();
        }
    }

   async function importAll() {
    console.log("æº–å‚™åŒ¯å…¥çš„è¡Œç¨‹è³‡æ–™ï¼š", currentItinerary); // ğŸ‘ˆ æª¢æŸ¥é€™è£¡æ˜¯å¦æœ‰å…©ç­†è³‡æ–™ï¼Œä¸”æ—¥æœŸä¸åŒ
    if (!confirm("ç¢ºå®šåŒ¯å…¥æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ")) return;

        // å–å¾—æŒ‰éˆ•é¡¯ç¤ºé€²åº¦
        const btn = document.querySelector("button[onclick='importAll()']");
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "åŒ¯å…¥ä¸­...";

        try {
            for (const item of currentItinerary) {
                // æ³¨æ„ï¼šé€™è£¡çš„æ¬„ä½è¦å°æ‡‰å¾Œç«¯çš„ data.get('...')
                const res = await fetch('/api/save_event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: item.date,      // å°æ‡‰ date_str
                        type: 'todo',          // æ—…éŠè¡Œç¨‹è¨­ç‚º todo
                        category: 'æ—…éŠè¡Œç¨‹',
                        content: item.content, // å°æ‡‰ content
                        amount: 0,             // é‡‘é¡è£œ 0
                        note: 'AI æ—…éŠåŠ©æ‰‹ç”Ÿæˆ'
                    })
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.message || "å„²å­˜å¤±æ•—");
                }
            }
            alert("ğŸ‰ æ‰€æœ‰è¡Œç¨‹å·²æˆåŠŸåŒ¯å…¥è¬å¹´æ›†ï¼");
            window.location.href = "/calendar"; // å°å‘è¬å¹´æ›†æŸ¥çœ‹çµæœ
        } catch (err) {
            console.error("åŒ¯å…¥å¤±æ•—:", err);
            alert("âŒ åŒ¯å…¥å¤±æ•—ï¼š" + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
</script>
{% endblock %}