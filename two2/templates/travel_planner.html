{% extends "base.html" %}

{% block content %}
<style>
    .ai-card {
        border-radius: 20px;
        border: none;
        transition: 0.3s;
    }

    .ai-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        border-left: 5px solid #0d6efd;
        padding-left: 15px;
        margin-bottom: 20px;
        font-weight: 700;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .history-card {
        cursor: pointer;
        border-left: 4px solid #198754;
        transition: 0.2s;
    }

    .history-card:hover {
        background-color: #f8f9fa;
    }

    .countdown-timer {
        font-size: 0.8rem;
        font-weight: bold;
        color: #dc3545;
        /* ç´…è‰² */
        background: #fff5f5;
        padding: 2px 8px;
        border-radius: 10px;
        display: inline-block;
        margin-top: 5px;
    }

    .status-expired {
        color: #6c757d;
        background: #f8f9fa;
    }

    /* å·²å‡ºç™¼çš„æ¨£å¼ */
</style>

<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 fw-bold">æ­£åœ¨ç‚ºæ‚¨è¦åŠƒæ—…ç¨‹...</h5>
</div>

<div class="container pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold mb-0">âœˆï¸ æ™ºèƒ½æ—…ç¨‹æº–å‚™ä¸­å¿ƒ</h2>
        <span class="badge bg-info text-dark">Powered by Gemini AI</span>
    </div>

    <div class="card ai-card shadow-sm p-4 mb-4">
        <form onsubmit="event.preventDefault(); askGemini();">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label fw-bold">ç›®çš„åœ°åœ‹å®¶/åŸå¸‚</label>
                    <input type="text" id="destInput" class="form-control form-control-lg" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬å¤§é˜ª"
                        required>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">éŠç©å¤©æ•¸</label>
                    <input type="number" id="daysInput" class="form-control form-control-lg" value="5" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">å‡ºç™¼æ—¥æœŸ</label>
                    <input type="date" id="dateInput" class="form-control form-control-lg" required>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-pill">
                        <i class="bi bi-magic"></i> ç”Ÿæˆå»ºè­°
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div id="resultArea" style="display: none;">
        <div class="row g-4">
            <div class="col-lg-5">
                <div class="card ai-card shadow-sm p-4 mb-4 bg-white">
                    <h5 class="section-title text-primary">ğŸŒ¦ï¸ å¤©æ°£èˆ‡ç©¿æ­å»ºè­°</h5>
                    <div id="weatherContent" class="mb-4"></div>
                    <h5 class="section-title text-warning"> Lantern ç•¶åœ°ç¿’ä¿—èˆ‡ç¦å¿Œ</h5>
                    <div id="customsContent"></div>
                </div>
            </div>
            <div class="col-lg-7">
                <div class="card ai-card shadow-sm p-4 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="section-title text-success mb-0">ğŸ§³ æ™ºèƒ½è¡Œææ¸…å–®</h5>
                        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="window.print()">
                            <i class="bi bi-printer"></i> åˆ—å°æ¸…å–®
                        </button>
                    </div>
                    <div id="packingListContent" class="row"></div>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="mt-4">
        <h4 class="fw-bold mb-4"><i class="bi bi-archive me-2"></i>å·²ä¿å­˜çš„æ—…ç¨‹</h4>
        <div id="historyList" class="row g-3">
        </div>
    </div>
</div>

<script>
    // åˆå§‹åŒ–ï¼šè®€å–æ­·å²ç´€éŒ„
    document.addEventListener('DOMContentLoaded', loadHistory);

    async function askGemini() {
        const dest = document.getElementById('destInput').value;
        const days = document.getElementById('daysInput').value;
        const date = document.getElementById('dateInput').value;

        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            const response = await fetch('/generate-travel-plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ destination: dest, days: days, date: date })
            });

            const res = await response.json();

            if (res.status === 'success') {
                displayResult(res.data);
                saveToStorage(dest, date, res.data); // ä¿å­˜åˆ°æœ¬åœ°
            } else {
                Swal.fire('éŒ¯èª¤', res.message, 'error');
            }
        } catch (e) {
            Swal.fire('éŒ¯èª¤', 'AI æš«æ™‚é›¢ç·šï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒ', 'error');
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
    }

    // æ¸²æŸ“çµæœåˆ°ç•«é¢
    function displayResult(data) {
        document.getElementById('resultArea').style.display = 'block';

        document.getElementById('weatherContent').innerHTML = `
        <p class="mb-2"><strong>å¤©æ°£æ¦‚æ³ï¼š</strong>${data.weather_forecast}</p>
        <div class="p-3 bg-light rounded-3 small"><strong>ğŸ’¡ ç©¿æ­å»ºè­°ï¼š</strong><br>${data.outfit_suggestion}</div>
    `;

        document.getElementById('customsContent').innerHTML = data.customs.map(c => `
        <div class="d-flex mb-2">
            <i class="bi bi-info-circle-fill text-warning me-2"></i>
            <span class="small">${c}</span>
        </div>
    `).join('');

        document.getElementById('packingListContent').innerHTML = data.packing_list.map(item => `
        <div class="col-md-6 mb-2">
            <div class="form-check">
                <input class="form-check-input" type="checkbox">
                <label class="form-check-label small">${item}</label>
            </div>
        </div>
    `).join('');

        window.scrollTo({ top: document.getElementById('resultArea').offsetTop - 100, behavior: 'smooth' });
    }

    // ---------------- å„²å­˜åŠŸèƒ½ ----------------

    function saveToStorage(dest, date, fullData) {
        let history = JSON.parse(localStorage.getItem('my_trips') || '[]');
        const record = { id: Date.now(), dest, date, fullData };
        history.unshift(record);
        localStorage.setItem('my_trips', JSON.stringify(history));
        loadHistory();
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('my_trips') || '[]');
        const container = document.getElementById('historyList');

        if (history.length === 0) {
            container.innerHTML = '<div class="col-12 text-muted">ç›®å‰é‚„æ²’æœ‰å„²å­˜çš„ç´€éŒ„ã€‚</div>';
            return;
        }

        container.innerHTML = history.map(item => `
        <div class="col-md-4">
            <div class="card shadow-sm history-card p-3 position-relative">
                <div onclick='displayResult(${JSON.stringify(item.fullData).replace(/'/g, "&apos;")})'>
                    <h6 class="fw-bold mb-1">${item.dest}</h6>
                    <small class="text-muted"><i class="bi bi-calendar-event me-1"></i>${item.date}</small>
                </div>
                <button class="btn btn-sm text-danger position-absolute top-0 end-0 m-2" onclick="deleteHistory(${item.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
    }

    function deleteHistory(id) {
        event.stopPropagation(); // é˜²æ­¢è§¸ç™¼çˆ¶å±¤çš„ click äº‹ä»¶
        Swal.fire({
            title: 'ç¢ºå®šåˆªé™¤ï¼Ÿ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'åˆªé™¤',
            cancelButtonText: 'å–æ¶ˆ'
        }).then((result) => {
            if (result.isConfirmed) {
                let history = JSON.parse(localStorage.getItem('my_trips') || '[]');
                history = history.filter(h => h.id !== id);
                localStorage.setItem('my_trips', JSON.stringify(history));
                loadHistory();
            }
        });
    }
    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('my_trips') || '[]');
        const container = document.getElementById('historyList');

        if (history.length === 0) {
            container.innerHTML = '<div class="col-12 text-muted">ç›®å‰é‚„æ²’æœ‰å„²å­˜çš„ç´€éŒ„ã€‚</div>';
            return;
        }

        container.innerHTML = history.map(item => `
        <div class="col-md-4">
            <div class="card shadow-sm history-card p-3 position-relative">
                <div onclick='displayResult(${JSON.stringify(item.fullData).replace(/'/g, "&apos;")})'>
                    <h6 class="fw-bold mb-1">${item.dest}</h6>
                    <div class="small text-muted mb-1">
                        <i class="bi bi-calendar-event me-1"></i>${item.date}
                    </div>
                    <div class="countdown-timer" data-date="${item.date}">
                        è¨ˆç®—ä¸­...
                    </div>
                </div>
                <button class="btn btn-sm text-danger position-absolute top-0 end-0 m-2" onclick="deleteHistory(${item.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `).join('');

        // æ¸²æŸ“å®Œå¾Œç«‹å³åŸ·è¡Œä¸€æ¬¡å€’æ•¸è¨ˆæ™‚æ›´æ–°
        updateAllCountdowns();
    }
    // æ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡æ‰€æœ‰å€’æ•¸è¨ˆæ™‚
    setInterval(updateAllCountdowns, 60000);

    function updateAllCountdowns() {
        const timers = document.querySelectorAll('.countdown-timer');
        const now = new Date();

        timers.forEach(timer => {
            const targetDate = new Date(timer.getAttribute('data-date'));
            // å°‡ç›®æ¨™æ—¥æœŸè¨­ç‚ºç•¶å¤© 00:00:00 é€²è¡Œæ¯”è¼ƒ
            targetDate.setHours(0, 0, 0, 0);
            now.setHours(0, 0, 0, 0);

            const diffTime = targetDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays > 0) {
                timer.innerHTML = `â³ é‚„æœ‰ ${diffDays} å¤©å‡ºç™¼`;
                timer.classList.remove('status-expired');
            } else if (diffDays === 0) {
                timer.innerHTML = `ğŸ‰ ä»Šå¤©å‡ºç™¼ï¼`;
                timer.classList.remove('status-expired');
                timer.style.color = '#198754'; // ç¶ è‰²
            } else {
                timer.innerHTML = `âœ… å·²å‡ºç™¼`;
                timer.classList.add('status-expired');
            }
        });
    }
</script>
{% endblock %}