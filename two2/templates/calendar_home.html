{% extends "base.html" %}
{% block content %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<meta name="referrer" content="no-referrer">
<style>
    /* å…¨åŸŸè¨­å®š */
    body {
        background-color: #f4f7f9 !important;
        font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
        overflow-x: hidden;
    }

    /* 1. æ˜ŸæœŸæ¨™é¡Œ */
    .fc-col-header-cell-cushion {
        color: #000000 !important;
        text-decoration: none !important;
        font-weight: 800 !important;
        font-size: 0.95rem;
    }

    /* 2. è¬å¹´æ›†å®¹å™¨ */
    #calendar {
        user-select: none;
        background: #ffffff;
        border-radius: 24px;
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
        padding: 10px;
        height: 700px;
    }

    .fc-scroller {
        overflow: hidden !important;
    }


    .fc-v-event,
    .fc-h-event {
        background-color: transparent !important;
        border: none !important;
    }

    /* é»æ“Šæ—¥æœŸé«˜äº® */
    .selected-day {
        background-color: #f0f7ff !important;
        box-shadow: inset 0 0 0 2px #007bff !important;
        border-radius: 8px;
    }

    /* æ ¼å…§æ•¸å­—æ¨£å¼ */
    .fc-daygrid-day-number {
        color: #333 !important;
        text-decoration: none !important;
        font-weight: 600;
        padding: 10px !important;
    }

    .cal-summary {
        font-size: 0.75rem;
        font-weight: 800;
        text-align: right;
        padding: 0 8px 5px 0;
    }

    .text-exp {
        color: #ff4757;
    }

    .text-inc {
        color: #2ed573;
    }

    .text-todo {
        color: #1e90ff;
    }

    /* 3. å³å´å°å¡ç¾åŒ– */
    .right-card {
        border-radius: 24px;
        border: none;
        background: #ffffff;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    }

    .right-header {
        padding: 30px 20px;
        border-bottom: 1px solid #f1f2f6;
    }

    .btn-action {
        border: 2px solid #f1f2f6;
        color: #57606f;
        font-size: 0.85rem;
        font-weight: 700;
        border-radius: 12px;
        transition: 0.3s;
        background: #ffffff;
    }

    .btn-action:hover {
        background: #f1f2f6;
        color: #2f3542;
    }

    .item-row {
        background: #ffffff !important;
        border-radius: 20px;
        border: 1px solid #eef2f7;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        padding: 18px;
        margin-bottom: 15px;
    }

    .item-row:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.1);
    }

    .indicator {
        width: 6px;
        border-radius: 10px;
        margin-right: 15px;
    }

    .bg-exp {
        background: #ff4757;
    }

    .bg-inc {
        background: #2ed573;
    }

    .bg-todo {
        background: #1e90ff;
    }

    /* è®“æ—¥æ›†æ–‡å­—æ›è¡Œ */
    .fc-event-main {
        white-space: pre-wrap !important;
        font-size: 0.85em;
        line-height: 1.4;
    }

    /* æ–°èè¼ªæ’­æ¢å„ªåŒ– */
    .news-card {
        transition: all 0.3s ease;
        border: 1px solid #eef2f7 !important;
    }

    .news-card:hover {
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1) !important;
    }

    #newsBox .carousel-item a:hover .fw-bold {
        color: #007bff !important;
        text-decoration: underline;
    }

    /* é™åˆ¶æ¨™é¡Œè¡Œæ•¸ */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<div class="container-fluid py-4">
    <div class="card news-card mb-4 border-0 shadow-sm overflow-hidden" style="border-radius: 24px;">
        <div id="newsCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
            <div class="carousel-inner" id="newsBox">
                <div class="carousel-item active">
                    <div class="p-5 text-center text-muted">ğŸ“¡ æ­£åœ¨ç²å–æ—…éŠæƒ…å ±...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div id='calendar'></div>
        </div>

        <div class="col-lg-4">
            <div class="card right-card h-100">
                <div class="right-header text-center">
                    <div id="viewDateDisplay" class="text-muted small fw-bold mb-1">æ­£åœ¨è¼‰å…¥...</div>
                    <h4 class="fw-bold mb-4">ç•¶æ—¥è¨˜éŒ„æ‘˜è¦</h4>
                    <div class="d-flex gap-2 flex-wrap"> <button class="btn btn-action flex-fill"
                            onclick="openModal('expense')">-æ”¯å‡º</button>
                        <button class="btn btn-action flex-fill" onclick="openModal('income')">+æ”¶å…¥</button>
                        <button class="btn btn-action flex-fill" onclick="openModal('todo')">ä»£è¾¦</button>
                        <button class="btn btn-action flex-fill" style="border-color: #6c5ce7; color: #6c5ce7;"
                            onclick="openRecurringModal()">
                            <i class="bi bi-arrow-repeat"></i> å›ºå®š
                        </button>
                    </div>
                </div>
                <div class="card-body" id="itemList" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="recurringModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 28px;">
            <div class="modal-header border-0 p-4 pb-0">
                <h5 class="fw-bold m-0">è¨­å®šå›ºå®šé€±æœŸè¨˜å¸³</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">æ”¶æ”¯é¡å‹</label>
                    <select id="rType" class="form-select border-0 shadow-none" style="background: #f8f9fa;">
                        <option value="expense">å›ºå®šæ”¯å‡º</option>
                        <option value="income">å›ºå®šæ”¶å…¥</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">æ¯æœˆæ‰£æ¬¾/å…¥å¸³æ—¥ (1-31)</label>
                    <input type="number" id="rDay" class="form-control border-0 shadow-none"
                        style="background: #f8f9fa;" min="1" max="31" value="1">
                </div>
                <div class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">é …ç›®åç¨±</label>
                    <input type="text" id="rContent" class="form-control border-0 shadow-none"
                        style="background: #f8f9fa;" placeholder="ä¾‹å¦‚ï¼šæˆ¿ç§Ÿã€è¨‚é–±è²»">
                </div>
                <div class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">é‡‘é¡ ($)</label>
                    <input type="number" id="rAmount" class="form-control border-0 shadow-none"
                        style="background: #f8f9fa;">
                </div>
                <div class="alert alert-info border-0 small mb-0" style="border-radius: 12px;">
                    <i class="bi bi-info-circle me-1"></i>
                    ç³»çµ±å°‡å¾<b>ç•¶å‰é¸æ“‡çš„æœˆä»½</b>é–‹å§‹ï¼Œæ¯æœˆè‡ªå‹•æ–°å¢ä¸€ç­†ç´€éŒ„ç›´åˆ°<b>ä»Šå¹´å¹´åº•</b>ã€‚
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button class="btn btn-dark w-100 py-3 fw-bold"
                    style="border-radius: 16px; background: #6c5ce7; border:none;"
                    onclick="handleSaveRecurring()">ç¢ºèªè¨­å®š</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 28px;">
            <div class="modal-header border-0 p-4 pb-0">
                <h5 id="modalTitle" class="fw-bold m-0">æ–°å¢è¨˜éŒ„</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="fId"><input type="hidden" id="fType">
                <div class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">é¸æ“‡åˆ†é¡</label>
                    <select id="fCategory" class="form-select form-select-lg border-light-subtle shadow-none"
                        style="background: #f8f9fa;"></select>
                </div>
                <div class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">åç¨± / æè¿°</label>
                    <input type="text" id="fContent"
                        class="form-control form-control-lg border-light-subtle shadow-none"
                        style="background: #f8f9fa;">
                </div>
                <div id="amountInputGroup" class="mb-3">
                    <label class="small text-muted mb-2 fw-bold">é‡‘é¡ ($)</label>
                    <input type="number" id="fAmount"
                        class="form-control form-control-lg border-light-subtle shadow-none"
                        style="background: #f8f9fa;">
                </div>
                <div class="mb-2">
                    <label class="small text-muted mb-2 fw-bold">å‚™è¨» (å¯é¸)</label>
                    <textarea id="fNote" class="form-control border-light-subtle shadow-none" rows="2"
                        style="background: #f8f9fa;"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 p-4 pt-0">
                <button class="btn btn-dark w-100 py-3 fw-bold" style="border-radius: 16px;"
                    onclick="handleSave()">å„²å­˜è¨˜éŒ„</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 24px; overflow: hidden; border: none;">
            <div class="modal-header bg-primary text-white p-4">
                <h5 class="modal-title fw-bold"><i class="bi bi-geo-alt-fill me-2"></i> ç·¨è¼¯æ—…éŠè¡Œç¨‹</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="edit-event-id">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">æ—¥æœŸ</label>
                        <input type="date" id="edit-date" class="form-control border-0 bg-light" readonly>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold text-muted">åˆ†é¡</label>
                        <input type="text" id="edit-category" class="form-control border-0 bg-light" value="æ—…éŠè¡Œç¨‹"
                            readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">è¡Œç¨‹è©³æƒ… (æ”¯æ´å¤šè¡Œæ–‡å­—)</label>
                    <textarea id="edit-content" class="form-control border-0 bg-light" rows="10"
                        style="white-space: pre-wrap; line-height: 1.6; border-radius: 15px;"></textarea>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-light px-4 py-2 fw-bold" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-outline-danger px-4 py-2 fw-bold"
                    onclick="deleteEvent()">åˆªé™¤æ­¤æ—¥</button>
                <button type="button" class="btn btn-primary px-5 py-2 fw-bold" style="border-radius: 12px;"
                    onclick="updateTripEvent()">å„²å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>
</div>

<script>
    let calendar;
    let activeDate = new Date().toISOString().split('T')[0];

    const categories = {
        expense: ['é£²é£Ÿ', 'å¦é«®', 'å¨›æ¨‚', 'äº¤é€š', 'é†«ç™‚', 'æˆ¿ç§Ÿ', 'ç”Ÿæ´»ç”¨å“', 'å…¶ä»–'],
        income: ['è–ªæ°´', 'çé‡‘', 'æ´¥è²¼', 'å…¼è·', 'æŠ•è³‡', 'åˆ©æ¯', 'å…¶ä»–'],
        todo: ['å¾…è¾¦äº‹é …', 'é‡è¦æé†’', 'æ—…éŠè¡Œç¨‹', 'å…¶ä»–']
    };

    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'zh-tw',
            headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
            contentHeight: 'auto',
            events: '/api/get_events',

            // --- æ–°å¢é€™æ®µï¼šç•¶æœˆä»½åˆ‡æ›æ™‚åŸ·è¡Œ ---
            // --- ä¿®æ­£å¾Œçš„ datesSetï¼šåˆ‡æ›æœˆä»½è‡ªå‹•æ›´æ–°å³å´ ---
            datesSet: function (info) {
                // 1. æŠ“å–æ¨™é¡Œä¸­çš„å¹´æœˆï¼ˆä½ åŸæœ¬çš„é‚è¼¯ï¼‰
                const title = info.view.title;
                const matches = title.match(/\d+/g);
                if (matches && matches.length >= 2) {
                    window.currentYear = matches[0];
                    window.currentMonth = matches[1];
                }

                // 2. ğŸ’¡ é—œéµé»ï¼šå–å¾—è©²æœˆä»½çš„ç¬¬ä¸€å¤© (info.view.currentStart)
                const viewDate = info.view.currentStart;
                const y = viewDate.getFullYear();
                const m = String(viewDate.getMonth() + 1).padStart(2, '0');
                const d = String(viewDate.getDate()).padStart(2, '0');

                // 3. æ›´æ–°å…¨åŸŸ activeDate ç‚ºè©²æœˆ 1 è™Ÿ (ä¾‹å¦‚ 2026-02-01)
                activeDate = `${y}-${m}-${d}`;

                // 4. æ›´æ–°å³å´é¢æ¿
                updateRightPanel();

                // 5. è¦–è¦ºç¾åŒ–ï¼šç§»é™¤èˆŠçš„é«˜äº®ï¼Œä¸¦å¹« 1 è™ŸåŠ ä¸Šé¸ä¸­æ¡†
                setTimeout(() => {
                    document.querySelectorAll('.fc-daygrid-day').forEach(el => el.classList.remove('selected-day'));
                    const firstDayEl = document.querySelector(`.fc-daygrid-day[data-date="${activeDate}"]`);
                    if (firstDayEl) firstDayEl.classList.add('selected-day');
                }, 50);
            },

            dateClick: function (info) {
                document.querySelectorAll('.fc-daygrid-day').forEach(el => el.classList.remove('selected-day'));
                info.dayEl.classList.add('selected-day');
                activeDate = info.dateStr;
                updateRightPanel();
            },
            eventContent: function (arg) {
                let exp = arg.event.extendedProps.total_exp || 0;
                let inc = arg.event.extendedProps.total_inc || 0;
                let todo = arg.event.extendedProps.has_todo || 0;
                let html = `<div class="cal-summary">`;
                if (exp > 0) html += `<div class="text-exp">-$${exp}</div>`;
                if (inc > 0) html += `<div class="text-inc">+$${inc}</div>`;
                if (todo) html += `<div class="text-todo">ğŸ“Œ</div>`;
                html += `</div>`;
                return { html: html };
            }
        });
        calendar.render();
        updateRightPanel();
        loadNews();
        // ç•¶ recurringModal è¢«éš±è—ï¼ˆé—œé–‰ï¼‰æ™‚ï¼Œè‡ªå‹•é‡ç½®è¡¨å–®
        const recModal = document.getElementById('recurringModal');
        recModal.addEventListener('hidden.bs.modal', function () {
            const form = recModal.querySelector('form');
            if (form) {
                form.reset();
            }
            // ç¢ºä¿æ‰€æœ‰ input éƒ½è¢«æ¸…ç©º
            recModal.querySelectorAll('input').forEach(input => {
                if (input.type !== 'submit' && input.type !== 'button') {
                    input.value = '';
                }
            });
        });
    });

    // æ§åˆ¶é€šç”¨å½ˆçª—é–‹å•Ÿ
    function openModal(type, data = null) {
        document.getElementById('fType').value = type;
        document.getElementById('fId').value = data ? data.id : '';
        document.getElementById('fContent').value = data ? data.content || '' : '';
        document.getElementById('fAmount').value = data ? data.amount || '' : '';
        document.getElementById('fNote').value = data ? data.note || '' : '';

        const catSelect = document.getElementById('fCategory');
        catSelect.innerHTML = categories[type].map(c => `<option value="${c}" ${data && data.category === c ? 'selected' : ''}>${c}</option>`).join('');

        document.getElementById('amountInputGroup').style.display = (type === 'todo') ? 'none' : 'block';
        document.getElementById('modalTitle').innerText = (data ? "ä¿®æ”¹" : "æ–°å¢") + (type === 'expense' ? 'æ”¯å‡º' : type === 'income' ? 'æ”¶å…¥' : 'äº‹é …');
        new bootstrap.Modal(document.getElementById('eventModal')).show();
    }

    // æ§åˆ¶æ—…éŠè¡Œç¨‹å½ˆçª—é–‹å•Ÿ
    function openEditTripModal(data) {
        // ç¢ºä¿é€™äº› ID å­˜åœ¨æ–¼ä½ çš„ HTML ä¸­
        const idEl = document.getElementById('edit-event-id');
        const dateEl = document.getElementById('edit-date');
        const contentEl = document.getElementById('edit-content');

        if (idEl) idEl.value = data.id;

        // å„ªå…ˆä½¿ç”¨è³‡æ–™åº«å›å‚³çš„æ—¥æœŸï¼Œè‹¥ç„¡å‰‡ç”¨ç›®å‰é¸å–çš„ activeDate
        if (dateEl) dateEl.value = data.date || activeDate;

        // å…§å®¹å¡«å……ï¼Œè™•ç†é›™é‡è½‰ç¾©çš„æ›è¡Œç¬¦
        if (contentEl) {
            contentEl.value = (data.content || "").replace(/\\n/g, '\n');
        }

        new bootstrap.Modal(document.getElementById('editEventModal')).show();
    }

    // å„²å­˜é€šç”¨è¨˜éŒ„ (å¼·åŒ–é˜²å‘†ç‰ˆ)
    async function handleSave() {
        const fType = document.getElementById('fType').value;
        const fContent = document.getElementById('fContent').value.trim();
        const fAmount = document.getElementById('fAmount').value;
        const fId = document.getElementById('fId').value;

        // 1. å…§å®¹å¿…å¡«æª¢æŸ¥
        if (!fContent) {
            alert("âš ï¸ è«‹è¼¸å…¥åç¨±æˆ–æè¿°ï¼");
            return;
        }

        // 2. é‡‘é¡é˜²å‘† (åƒ…é‡å°æ”¯å‡ºèˆ‡æ”¶å…¥)
        if (fType !== 'todo') {
            if (fAmount === "" || isNaN(fAmount)) {
                alert("âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡ï¼");
                return;
            }
            if (parseFloat(fAmount) < 0) {
                alert("âš ï¸ é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸ï¼");
                return;
            }
        }

        const payload = {
            id: fId,
            type: fType,
            category: document.getElementById('fCategory').value,
            content: fContent,
            amount: fType === 'todo' ? 0 : parseFloat(fAmount), // è½‰ç‚ºæ•¸å­—
            note: document.getElementById('fNote').value.trim(),
            date: activeDate
        };

        const res = await fetch('/api/save_event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (result.status === 'success') {
            alert("âœ¨ è¨˜éŒ„å„²å­˜æˆåŠŸï¼");
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            calendar.refetchEvents();
            updateRightPanel();
        } else {
            alert("âŒ å„²å­˜å¤±æ•—ï¼š" + result.message);
        }
    }

    // å„²å­˜æ—…éŠè¡Œç¨‹ä¿®æ”¹
    async function updateTripEvent() {
        const e_id = document.getElementById('edit-event-id').value;
        const e_content = document.getElementById('edit-content').value.trim(); // ç¢ºä¿æŠ“åˆ° text area
        const e_date = document.getElementById('edit-date').value;

        if (!e_content) {
            alert("è«‹è¼¸å…¥è¡Œç¨‹æè¿°å…§å®¹");
            return;
        }

        const payload = {
            id: e_id,
            content: e_content,
            date: e_date,
            category: 'æ—…éŠè¡Œç¨‹',
            type: 'todo',
            amount: 0,
            note: 'AI è¡Œç¨‹æ›´æ–°'
        };

        const res = await fetch('/api/save_event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (result.status === 'success') {
            alert("âœ… è¡Œç¨‹å·²æ›´æ–°");
            bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
            calendar.refetchEvents();
            updateRightPanel();
        } else {
            alert("âŒ å„²å­˜å¤±æ•—ï¼š" + result.message);
        }
    }


    // åˆªé™¤æŒ‰éˆ• (ç”¨æ–¼è¡Œç¨‹ Modal)
    function deleteEvent() {
        const id = document.getElementById('edit-event-id').value;
        deleteItem(id).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
        });
    }

    // å°‹æ‰¾ updateRightPanel å‡½å¼ï¼Œä¿®æ”¹ fetching ä¹‹å¾Œçš„éƒ¨åˆ†
    async function updateRightPanel() {
        document.getElementById('viewDateDisplay').innerText = activeDate;
        const res = await fetch(`/api/get_events?date=${activeDate}`);
        const rawData = await res.json();

        // ğŸŸ¢ é—œéµä¿®æ­£ï¼šæ’é™¤æ‰å¾Œç«¯æ¨™è¨˜ç‚ºå·²åˆªé™¤çš„é …ç›®
        const data = rawData.filter(i => i.note !== 'DELETED');
        const list = document.getElementById('itemList');

        // ä¿®æ”¹ updateRightPanel å…§çš„ data.map è¿´åœˆè™•
        list.innerHTML = data.map(i => {
            // ç¢ºä¿ i.amount æ˜¯æ•¸å­—ï¼Œé¿å… undefined é¡¯ç¤ºåœ¨ç•«é¢ä¸Š
            const amount = i.amount || 0;

            // çµ±ä¸€æ—¥æœŸèˆ‡æ¬„ä½
            const safeItem = {
                ...i,
                amount: amount,
                date: i.event_date || activeDate
            };

            // è™•ç† JSON è½‰ç¾©ï¼Œé¿å… content å…§çš„ç‰¹æ®Šå­—å…ƒå¼„å£ HTML
            const itemJson = JSON.stringify(safeItem).replace(/"/g, '&quot;');

            const isTrip = i.category === 'æ—…éŠè¡Œç¨‹';
            const isRecurring = i.recurring_task_id != null; // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå‹•åŒ–å¸³ç›®
            const colorBg = i.type === 'expense' ? 'bg-exp' : (i.type === 'income' ? 'bg-inc' : 'bg-todo');
            const colorText = i.type === 'expense' ? 'text-exp' : (i.type === 'income' ? 'text-inc' : 'text-todo');
            const editAction = isTrip ? `openEditTripModal(${itemJson})` : `openModal('${i.type}', ${itemJson})`;

            return `
<div class="item-row d-flex align-items-center">
    <div class="indicator ${colorBg}" style="height: 50px;"></div>
    <div class="flex-grow-1">
        <div class="small text-muted fw-bold">
            ${i.category} ${isRecurring ? '<span class="badge bg-secondary">ğŸ”„ è‡ªå‹•</span>' : ''}
        </div>
        <div class="fw-bold text-dark text-truncate" style="max-width: 180px;">${i.content}</div>
        <div class="mt-2">
            <button class="btn btn-link btn-sm text-primary p-0 me-3 text-decoration-none fw-bold" onclick="${editAction}">
                <i class="bi bi-pencil-square"></i> ç·¨è¼¯
            </button>
            <button class="btn btn-link btn-sm text-danger p-0 me-3 text-decoration-none fw-bold" onclick="deleteItem('${i.id}')">
                <i class="bi bi-trash"></i> åˆªé™¤æ­¤ç­†
            </button>
            ${isRecurring ? `
            <button class="btn btn-link btn-sm text-dark p-0 text-decoration-none fw-bold" onclick="deleteRecurringRule('${i.recurring_task_id}')">
                <i class="bi bi-x-circle"></i> åˆªé™¤è¦å‰‡
            </button>` : ''}
        </div>
    </div>
    <div class="text-end fw-bold fs-5 ${colorText}">
        ${i.type === 'todo' ? 'ğŸ“Œ' : (i.type === 'expense' ? '-' : '+') + '$' + i.amount}
    </div>
</div>`;
        }).join('') || '<div class="text-center py-5 text-muted fw-bold">ğŸ“… ä»Šæ—¥ç„¡ä»»ä½•è¨˜éŒ„</div>';
    }

    async function deleteItem(id) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™é …ç´€éŒ„å—ï¼Ÿ")) return;

        try {
            const res = await fetch('/api/delete_event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id })
            });
            const data = await res.json();

            if (data.status === 'success') {
                alert("å·²æˆåŠŸåˆªé™¤ï¼");
                // é€™è£¡ä¸è¦ç”¨ location.reload()ï¼Œæ”¹ç”¨ä»¥ä¸‹å…©è¡Œå¯ä»¥å¯¦ç¾ç„¡åˆ·æ›´æ–°
                calendar.refetchEvents();
                updateRightPanel();
            } else {
                alert("åˆªé™¤å¤±æ•—ï¼š" + data.message);
            }
        } catch (err) {
            console.error("ç¶²è·¯é€£ç·šéŒ¯èª¤:", err);
            alert("ç¶²è·¯é€£ç·šéŒ¯èª¤");
        }
    }

    async function loadNews() {
        try {
            const box = document.getElementById('newsBox');
            if (!box) return;

            const res = await fetch('/api/get_news');
            const data = await res.json();

            // æª¢æŸ¥å¾Œç«¯æ˜¯å¦çœŸçš„æœ‰å›å‚³è³‡æ–™
            if (data.results && data.results.length > 0) {
                let htmlContent = "";

                data.results.forEach((n, i) => {
                    // 1. è™•ç†åœ–ç‰‡ç¶²å€ï¼Œç¢ºä¿å®ƒæ˜¯ https
                    let img = n.image_url;
                    if (img && img.startsWith('//')) img = 'https:' + img;

                    // 2. éš¨æ©Ÿé¢¨æ™¯å‚™ç”¨åœ– (Unsplash)
                    const fallbackImg = `https://images.unsplash.com/photo-1506744038136-46273834b3fb?w=800&q=80`;

                    htmlContent += `
                <div class="carousel-item ${i === 0 ? 'active' : ''}">
                    <a href="${n.link}" target="_blank" class="text-decoration-none d-flex align-items-center" 
                    style="height:150px; background:#fff; border-radius: 15px; overflow: hidden;">
                        <div style="width:220px; height:150px; overflow:hidden; flex-shrink:0; background: #eee;">
                            <img src="${img}" 
                                class="h-100 w-100" 
                                style="object-fit:cover; transition: transform 0.5s;"
                                referrerpolicy="no-referrer"
                                onmouseover="this.style.transform='scale(1.1)'"
                                onmouseout="this.style.transform='scale(1)'"
                                onerror="this.onerror=null; this.src='${fallbackImg}';">
                        </div>
                        <div class="p-3 flex-grow-1" style="min-width: 0;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge rounded-pill bg-danger bg-opacity-10 text-danger px-3" style="font-size:0.7rem;">ğŸ”¥ æœ€æ–°æƒ…å ±</span>
                                <small class="text-muted fw-bold" style="font-size: 0.75rem;"><i class="bi bi-newspaper me-1"></i>${n.source_id}</small>
                            </div>
                            <div class="fw-bold text-dark line-clamp-2" style="font-size: 1rem; line-height: 1.5; letter-spacing: 0.3px;">
                                ${n.title}
                            </div>
                        </div>
                    </a>
                </div>`;
                });

                box.innerHTML = htmlContent;

                // é‡æ–°åˆå§‹åŒ–è¼ªæ’­çµ„ä»¶
                const carouselEl = document.querySelector('#newsCarousel');
                if (carouselEl) {
                    new bootstrap.Carousel(carouselEl, {
                        interval: 4000,
                        ride: 'carousel'
                    });
                }
            } else {
                box.innerHTML = '<div class="carousel-item active"><div class="p-5 text-center text-muted">ç›®å‰æš«ç„¡æ›´æ–°æƒ…å ±</div></div>';
            }
        } catch (e) {
            console.error("News Load Error:", e);
            document.getElementById('newsBox').innerHTML = '<div class="carousel-item active"><div class="p-5 text-center text-danger">âš ï¸ æƒ…å ±åŠ è¼‰å¤±æ•—</div></div>';
        }
    }

    // æ‰“é–‹å›ºå®šè¨˜å¸³ Modal
    function openRecurringModal() {
        const modalElement = document.getElementById('recurringModal');

        // 1. æ‰¾åˆ° Modal è£¡é¢çš„ Form ä¸¦é‡ç½®
        const form = modalElement.querySelector('form');
        if (form) {
            form.reset();
        }

        // 2. é‡å°æ²’æœ‰è¢« form.reset() æ¸…é™¤çš„éš±è—æ¬„ä½æˆ–ç‰¹æ®Šæ¬„ä½æ‰‹å‹•æ¸…ç©º
        // ä¾‹å¦‚ï¼šå¦‚æœä½ æœ‰å„²å­˜ ID çš„éš±è—æ¬„ä½ï¼Œä¸€å®šè¦æ¸…æ‰ï¼Œå¦å‰‡ã€Œæ–°å¢ã€æœƒè®Šæˆã€Œç·¨è¼¯ã€
        const idInput = modalElement.querySelector('input[type="hidden"]');
        if (idInput) {
            idInput.value = "";
        }

        // 3. é¡¯ç¤º Modal
        const modalInstance = new bootstrap.Modal(modalElement);
        modalInstance.show();
    }

    // è™•ç†å›ºå®šè¨˜å¸³å„²å­˜
    async function handleSaveRecurring() {
        const type = document.getElementById('rType').value;
        const content = document.getElementById('rContent').value.trim();
        const amount = document.getElementById('rAmount').value;
        const day = document.getElementById('rDay').value;

        if (!content || !amount || !day) {
            alert("âš ï¸ è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼");
            return;
        }

        const payload = {
            type: type,
            category: (type === 'expense' ? 'å›ºå®šæ”¯å‡º' : 'å›ºå®šæ”¶å…¥'),
            content: content,
            amount: parseFloat(amount),
            day_of_month: parseInt(day),
            start_date: activeDate // ä½¿ç”¨æ—¥æ›†ç›®å‰é¸ä¸­çš„æ—¥æœŸï¼ˆæˆ–è©²æœˆï¼‰
        };

        try {
            const res = await fetch('/api/save_recurring_fixed', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (result.status === 'success') {
                alert("âœ¨ è¨­å®šæˆåŠŸï¼å·²è‡ªå‹•å¡«å¯«è‡³å¹´åº•ã€‚");
                bootstrap.Modal.getInstance(document.getElementById('recurringModal')).hide();

                // é‡æ–°æ•´ç†æ—¥æ›†èˆ‡åˆ—è¡¨
                calendar.refetchEvents();
                updateRightPanel();
            } else {
                alert("âŒ å¤±æ•—ï¼š" + result.message);
            }
        } catch (err) {
            console.error(err);
            alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
    }
    async function deleteRecurringRule(taskId) {
        if (!confirm("âš ï¸ ç¢ºå®šè¦åˆªé™¤æ­¤ã€è‡ªå‹•åŒ–è¦å‰‡ã€å—ï¼Ÿ\né€™æœƒé€£åŒè¬å¹´æ›†ä¸Šæ‰€æœ‰æœˆä»½çš„ç›¸é—œå¸³ç›®ä¸€ä½µç§»é™¤ï¼")) return;

        try {
            // ç¶²å€è¦å°æ‡‰ä¸Šé¢å®šç¾©çš„ /delete_recurring_task/
            const res = await fetch(`/delete_recurring_task/${taskId}`, {
                method: 'POST'
            });

            const result = await res.json();
            if (result.status === 'success') {
                alert("âœ¨ è¦å‰‡åŠé—œè¯å¸³ç›®å·²å…¨æ•¸ç§»é™¤ï¼");
                calendar.refetchEvents();
                updateRightPanel();
            } else {
                alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + result.message);
            }
        } catch (err) {
            console.error("åˆªé™¤è¦å‰‡éŒ¯èª¤:", err);
        }
    }
</script>
{% endblock %}