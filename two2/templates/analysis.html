{% extends "base.html" %}
{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* 1. å…¨åŸŸè³ªæ„Ÿæå‡ */
    .card-dashboard {
        border-radius: 20px;
        border: none;
        background: #fff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease;
    }

    .stat-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: #8898aa;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 800;
        color: #32325d;
    }

    /* 2. AI åŠ©æ‰‹å°ˆå±¬æ¨£å¼ */
    .ai-card {
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        color: white;
        overflow: hidden;
        position: relative;
        border: none;
    }

    .ai-card::after {
        content: '';
        position: absolute;
        top: -50%;
        right: -20%;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    #aiContent {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(5px);
        border-radius: 12px;
        padding: 15px;
        min-height: 80px;
        border-left: 4px solid #fff;
        font-size: 0.95rem;
        line-height: 1.6;
    }

    /* 3. æ’è¡Œæ¦œèˆ‡åˆ—è¡¨å„ªåŒ– */
    .rank-item {
        padding: 12px 15px;
        border-bottom: 1px solid #f8f9fa;
        display: flex;
        align-items: center;
    }

    .rank-item:last-child {
        border: none;
    }

    .badge-rank {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .trend-container,
    .pie-container {
        position: relative;
        width: 100%;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1 text-dark">ğŸ“Š æ•¸æ“šåˆ†æèˆ‡é ç®—</h3>
            <p class="text-muted small">è¿½è¹¤æ¶ˆè²»è¶¨å‹¢èˆ‡é ç®—é€²åº¦</p>
        </div>
        <button class="btn btn-dark btn-sm px-4 py-2 shadow-sm" style="border-radius: 10px;" onclick="setBudget()">
            <i class="bi bi-pencil-square me-2"></i>è¨­å®šé ç®—
        </button>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-7">
            <div class="card card-dashboard p-4 h-100">
                <div class="stat-title mb-3">æ¯æœˆé ç®—é€²åº¦</div>
                <div class="row align-items-end">
                    <div class="col-md-7">
                        <div class="d-flex align-items-baseline gap-2">
                            <div class="stat-value" id="expDisplay">$0</div>
                            <div class="text-muted small">/ <span id="budgetLimitDisplay">$20,000</span></div>
                        </div>
                    </div>
                    <div class="col-md-5 text-md-end">
                        <div id="budgetNote" class="small fw-bold"></div>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 12px; border-radius: 10px;">
                    <div id="budgetBar" class="progress-bar progress-bar-striped progress-bar-animated"
                        role="progressbar"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="card card-dashboard p-4 h-100 text-center">
                <div class="stat-title mb-2">æœ¬æœˆæ·¨çµé¤˜</div>
                <div id="netDisplay" class="stat-value mb-2">$0</div>
                <div class="row border-top pt-3 mt-2">
                    <div class="col-6 border-end">
                        <small class="text-muted d-block">ç¸½æ”¶å…¥</small>
                        <span class="text-success fw-bold" id="totalInc">$0</span>
                    </div>
                    <div class="col-6">
                        <small class="text-muted d-block">ç¸½æ”¯å‡º</small>
                        <span class="text-danger fw-bold" id="totalExp">$0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-dashboard ai-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0 text-white"><i class="bi bi-stars me-2"></i>AI æ™ºæ…§ç†è²¡é¡§å•</h5>
                    <button class="btn btn-light btn-sm fw-bold px-3 shadow-sm" onclick="getAIAdvice()" id="aiBtn"
                        style="border-radius: 8px;">
                        é–‹å§‹æ™ºæ…§è¨ºæ–·
                    </button>
                </div>
                <div id="aiContent" class="text-white">
                    é»æ“ŠæŒ‰éˆ•ï¼ŒGemini å°‡æ ¹æ“šæœ¬æœˆæ”¯å‡ºæ•¸æ“šç‚ºæ‚¨æä¾›å°ˆå±¬ç†è²¡å»ºè­°...
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card card-dashboard p-4">
                <h6 class="fw-bold mb-4">è¿‘åŠå¹´æ”¶æ”¯è¶¨å‹¢</h6>
                <div class="trend-container" style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card card-dashboard p-4">
                <h6 class="fw-bold mb-4">æ”¯å‡ºä½”æ¯”åˆ†æ</h6>
                <div class="pie-container" style="height: 300px;">
                    <canvas id="categoryPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card card-dashboard p-4">
                <h6 class="fw-bold mb-4">æ”¯å‡ºæ’è¡Œ Top 5</h6>
                <div id="topList"></div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card card-dashboard p-4">
                <h6 class="fw-bold mb-4">åˆ†é¡æ•¸æ“šæ˜ç´°</h6>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3 border-0 rounded-start">åˆ†é¡é …ç›®</th>
                                <th class="border-0 text-center">é‡‘é¡</th>
                                <th class="border-0">ä½”æ¯”é€²åº¦</th>
                                <th class="pe-3 border-0 rounded-end text-end">å¹³å‡å–®ç­†</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let trendChartInstance = null;
    let pieChartInstance = null;
    let currentBudget = parseFloat(localStorage.getItem('user_budget')) || 20000;

    // ğŸš€ [é—œéµä¿®å¾©]ï¼šæ–°å¢å‰ç«¯é˜²è­·é–ï¼Œé˜²æ­¢åŒä¸€æ¬¡é é¢è¼‰å…¥æœŸé–“é‡è¤‡å‘¼å«ç™¼ä¿¡ API
    let warningSentInThisSession = false;

    // 1. ç²å– URL åƒæ•¸ (å¾è¬å¹´æ›†å‚³ä¾†çš„æœˆä»½)
    const urlParams = new URLSearchParams(window.location.search);
    const filterYear = urlParams.get('year');
    const filterMonth = urlParams.get('month');

    // 2. åˆå§‹åŒ–è¼‰å…¥æ•¸æ“š
    async function loadData() {
        let apiUrl = '/api/analysis_data';
        if (filterYear && filterMonth) {
            apiUrl += `?year=${filterYear}&month=${filterMonth}`;
        }

        try {
            const res = await fetch(apiUrl);
            const data = await res.json();

            if (data.error) throw new Error(data.error);

            // A. æ›´æ–°æ¦‚è¦½æ•¸æ“š
            const summary = data.summary;
            document.getElementById('totalInc').innerText = `$${summary.total_inc.toLocaleString()}`;
            document.getElementById('totalExp').innerText = `$${summary.total_exp.toLocaleString()}`;
            document.getElementById('expDisplay').innerText = `$${summary.total_exp.toLocaleString()}`;

            const net = summary.balance;
            const netEl = document.getElementById('netDisplay');
            netEl.innerText = `${net >= 0 ? '' : '-'}$${Math.abs(net).toLocaleString()}`;
            netEl.className = `stat-value mb-2 ${net >= 0 ? 'text-success' : 'text-danger'}`;

            // B. æ›´æ–°é ç®—é€²åº¦æ¢
            updateBudgetUI(summary.total_exp);

            // C. æ¸²æŸ“æ”¯å‡ºæ’è¡Œ
            renderTopList(data.top_expenses);

            // D. æ¸²æŸ“åˆ†é¡è¡¨æ ¼
            renderCategoryTable(data.category_distribution, summary.total_exp);

            // E. æ¸²æŸ“åœ–è¡¨
            renderTrendChart(data.trend);
            renderPieChart(data.category_distribution);

        } catch (err) {
            console.error("è¼‰å…¥å¤±æ•—:", err);
            alert("ç„¡æ³•è¼‰å…¥æ•¸æ“šï¼Œè«‹æª¢æŸ¥é€£ç·šæˆ–ç¨å¾Œå†è©¦");
        }
    }

    // 3. é ç®—é€²åº¦æ¢é‚è¼¯
    function updateBudgetUI(totalExp) {
        document.getElementById('budgetLimitDisplay').innerText = `$${currentBudget.toLocaleString()}`;
        const percent = (totalExp / currentBudget) * 100;
        const bar = document.getElementById('budgetBar');

        bar.style.width = Math.min(percent, 100) + '%';

        if (percent >= 100) {
            bar.className = "progress-bar bg-danger progress-bar-striped";
            document.getElementById('budgetNote').innerHTML = `<span class="text-danger">âš ï¸ å·²è¶…æ”¯</span>`;

            // ğŸš€ [ä¿®æ­£é»]ï¼šåŠ ä¸Šåˆ¤æ–·é–ï¼Œå¦‚æœæœ¬æ¬¡æ‰“é–‹ç¶²é å·²ç¶“è·‘é trigger äº†ï¼Œå°±ä¸å†é‡è¤‡ fetch
            if (!warningSentInThisSession) {
                triggerBudgetWarning(totalExp, currentBudget);
            }

        } else if (percent >= 80) {
            bar.className = "progress-bar bg-warning progress-bar-striped";
            document.getElementById('budgetNote').innerHTML = `<span class="text-warning">æ¥è¿‘ä¸Šé™</span>`;
        } else {
            bar.className = "progress-bar bg-success progress-bar-striped";
            document.getElementById('budgetNote').innerHTML = `<span class="text-success">é€²åº¦æ­£å¸¸</span>`;
            // å¦‚æœåˆªé™¤è³‡æ–™å¾Œæ”¯å‡ºä½æ–¼é ç®—ï¼Œå‰‡é‡ç½®ç‹€æ…‹ï¼Œè®“ä¸‹æ¬¡è¶…æ¨™æ™‚é‚„èƒ½ç™¼ä¿¡
            warningSentInThisSession = false;
        }
    }

    // 4. æ¸²æŸ“æ”¯å‡ºæ’è¡Œ
    function renderTopList(items) {
        const container = document.getElementById('topList');
        if (!items || items.length === 0) {
            container.innerHTML = '<div class="text-muted p-3 text-center small">æœ¬æœˆå°šç„¡ç´€éŒ„</div>';
            return;
        }

        container.innerHTML = items.map((i, idx) => `
            <div class="rank-item">
                <div class="badge-rank ${idx < 3 ? 'bg-primary text-white' : 'bg-light text-muted'} me-3">${idx + 1}</div>
                <div class="flex-grow-1">
                    <div class="fw-bold small mb-0">${i.display_name}</div>
                    <small class="text-muted">${i.category || 'ä¸€èˆ¬'}</small>
                </div>
                <div class="text-danger fw-bold small">-$${Math.abs(i.total).toLocaleString()}</div>
            </div>
        `).join('');
    }

    // 5. æ¸²æŸ“åˆ†é¡æ˜ç´°è¡¨æ ¼
    function renderCategoryTable(categories, totalExp) {
        const tbody = document.getElementById('categoryTableBody');
        if (!categories || categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ç„¡æ•¸æ“š</td></tr>';
            return;
        }

        tbody.innerHTML = categories.map(c => {
            const percent = totalExp > 0 ? Math.round((c.total / totalExp) * 100) : 0;
            return `
                <tr>
                    <td class="ps-3 fw-bold text-dark">${c.category}</td>
                    <td class="text-center fw-bold">$${c.total.toLocaleString()}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="progress flex-grow-1" style="height: 6px;">
                                <div class="progress-bar bg-primary" style="width: ${percent}%"></div>
                            </div>
                            <small class="text-muted">${percent}%</small>
                        </div>
                    </td>
                    <td class="pe-3 text-end text-muted small">$${c.total.toLocaleString()}</td>
                </tr>
            `;
        }).join('');
    }

    // 6. åœ–è¡¨å¯¦ä½œ (Chart.js)
    function renderTrendChart(trendData) {
        const ctx = document.getElementById('trendChart').getContext('2d');
        if (trendChartInstance) trendChartInstance.destroy();

        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.map(d => d.month_label),
                datasets: [
                    { label: 'æ”¶å…¥', data: trendData.map(d => d.income), borderColor: '#2dce89', tension: 0.4, fill: false },
                    { label: 'æ”¯å‡º', data: trendData.map(d => d.expense), borderColor: '#f5365c', tension: 0.4, fill: false }
                ]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }

    function renderPieChart(categories) {
        const ctx = document.getElementById('categoryPieChart').getContext('2d');
        if (pieChartInstance) pieChartInstance.destroy();

        pieChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: categories.map(c => c.category),
                datasets: [{
                    data: categories.map(c => c.total),
                    backgroundColor: ['#5e72e4', '#2dce89', '#11cdef', '#fb6340', '#f5365c', '#adb5bd']
                }]
            },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '70%' }
        });
    }

    // 7. AI æ™ºæ…§è¨ºæ–·
    async function getAIAdvice() {
        const aiContent = document.getElementById('aiContent');
        const aiBtn = document.getElementById('aiBtn');
        aiBtn.disabled = true;
        aiBtn.innerText = "æ­£åœ¨æ€è€ƒä¸­...";

        try {
            let aiUrl = '/api/ai_financial_advice';
            if (filterYear && filterMonth) aiUrl += `?year=${filterYear}&month=${filterMonth}`;

            const res = await fetch(aiUrl);
            const data = await res.json();

            if (data.advice) {
                aiContent.innerHTML = data.advice.replace(/\n/g, '<br>');
            } else {
                aiContent.innerText = "ç„¡æ³•ç”Ÿæˆå»ºè­°ï¼Œè«‹ç¢ºä¿æœ¬æœˆæœ‰æ”¯å‡ºç´€éŒ„ã€‚";
            }
        } catch (err) {
            aiContent.innerText = "âŒ è¨ºæ–·å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        } finally {
            aiBtn.disabled = false;
            aiBtn.innerText = "é‡æ–°è¨ºæ–·";
        }
    }

    // 8. è¨­å®šé ç®—åŠŸèƒ½
    function setBudget() {
        const val = prompt("è«‹è¼¸å…¥æ¯æœˆé ç®—é‡‘é¡:", currentBudget);
        if (val && !isNaN(val)) {
            currentBudget = parseFloat(val);
            localStorage.setItem('user_budget', currentBudget);
            // è¨­å®šæ–°é ç®—å¾Œé‡ç½®ç™¼ä¿¡é–ï¼Œè‹¥æ–°é ç®—ä»è¶…æ¨™å¯å†æ¬¡è§¸ç™¼
            warningSentInThisSession = false;
            loadData();
        }
    }

    // 9. å‘¼å«å¾Œç«¯ç™¼é€ Email è­¦å‘Š (æ•´åˆç‹€æ…‹é–)
    async function triggerBudgetWarning(exp, budget) {
        // é€™è£¡ä¸éœ€è¦ warningSentInThisSession é–äº†ï¼Œäº¤çµ¦å¾Œç«¯åˆ¤æ–·
        try {
            const res = await fetch('/api/send_budget_warning', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ exp: exp, budget: budget })
            });
            const data = await res.json();

            if (data.status === 'sent') {
                alert(`âš ï¸ é ç®—è¶…æ¨™ï¼è­¦å‘Šéƒµä»¶å·²ç™¼é€è‡³æ‚¨çš„ä¿¡ç®±ã€‚\nç›®å‰æ”¯å‡ºï¼š$${exp.toLocaleString()}\né ç®—ä¸Šé™ï¼š$${budget.toLocaleString()}`);
            } else {
                // skipped ç‹€æ…‹ä¸å½ˆçª—ï¼Œé¿å…å¹²æ“¾ä½¿ç”¨è€…
                console.log("ç™¼ä¿¡ç‹€æ…‹:", data.message);
            }
        } catch (err) {
            console.error("âŒ ç„¡æ³•é€£æ¥ç™¼ä¿¡ API");
        }
    }

    document.addEventListener('DOMContentLoaded', loadData);
</script>
{% endblock %}